<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFind - Maqueta de App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variables y reset */
        :root {
            --accent: #2563eb;
            /* azul accesible */
            --muted: #6b7280;
            --frame-bg: #1a202c;
        }

        html,
        body {
            height: 100%;
            box-sizing: border-box;
            margin: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #e5e7eb;
        }

        /* --- Tema claro / marco móvil --- */
        .mobile-frame {
            max-width: 420px;
            height: 880px;
            margin: 1.5rem auto;
        }

        .mobile-screen {
            background-color: #f7fafc;
            width: 100%;
            height: 100%;
            border-radius: 30px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- Dark theme: colores más contrastados y habituales en móviles --- */
        .dark {
            --bg-surface: #0b1220;
            /* fondo principal - muy oscuro */
            --bg-elevated: #111827;
            /* tarjetas / elevaciones */
            --text-primary: #E6EEF8;
            /* texto principal claro */
            --text-secondary: #9CA3AF;
            /* texto secundario suave */
            --border-dark: #1f2937;
            /* bordes en tema oscuro */
            --input-bg-dark: #0b1220;
            /* campos de formulario */
            --accent: #2563eb;
            /* acento azul */
        }

        .dark .mobile-screen {
            background-color: var(--bg-surface);
            color: var(--text-primary);
        }

        .dark body {
            background-color: #000;
            /* respaldo fuera del marco */
        }

        /* tarjetas / superficies */
        .card {
            background-color: #ffffff;
            border-color: #e5e7eb;
            /* ...existing code... */
        }

        /* Evitar fondo oscuro en categorías en modo claro */
        #home-categories-list,
        #categories-list {
            background: transparent !important;
        }

        /* Pills de categorías mejorados */
        .category-pill {
            display: inline-block;
            padding: 0.5rem 1.1rem;
            border-radius: 1.5rem;
            background: #f3f4f6;
            color: #222;
            font-size: 1rem;
            font-weight: 500;
            border: 1px solid #e5e7eb;
            margin: 0.15rem 0.1rem;
            transition: box-shadow 0.18s, background 0.18s;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
            text-align: center;
            min-width: 0;
            max-width: 100%;
            word-break: break-word;
        }

        .dark .category-pill {
            background: #111827;
            color: #e6eef8;
            border: 1px solid #222a36;
        }

        .category-pill:hover {
            background: #e0e7ef;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.08);
        }

        .dark .category-pill:hover {
            background: #1a2332;
        }

        /* Eliminar llave extra que causaba error de sintaxis */
        .dark .card {
            background-color: var(--bg-elevated);
            border-color: var(--border-dark);
            color: var(--text-primary);
        }

        /* barra de navegación inferior */
        .nav-bar {
            background-color: #ffffff;
            border-top-color: #e5e7eb;
        }

        .dark .nav-bar {
            background-color: var(--bg-elevated);
            border-top-color: var(--border-dark);
        }

        .nav-button {
            color: #6b7280;
        }

        .dark .nav-button {
            color: var(--text-secondary);
        }

        .nav-button.active {
            color: #2563eb;
        }

        .dark .nav-button.active {
            color: var(--accent);
        }

        /* Inputs / selects / textareas */
        input,
        select,
        textarea {
            background-color: #fff;
            border: 1px solid #e5e7eb;
            color: #111827;
        }

        .dark input,
        .dark select,
        .dark textarea {
            background-color: var(--input-bg-dark);
            border: 1px solid var(--border-dark);
            color: var(--text-primary);
        }

        /* Placeholders más suaves en oscuro */
        .dark input::placeholder,
        .dark textarea::placeholder {
            color: #9aa4b2;
        }

        input[type="checkbox"].peer+div {
            position: relative;
            display: inline-block;
            width: 2.75rem;
            /* equivalente a w-11 */
            height: 1.5rem;
            /* equivalente a h-6 */
            border-radius: 9999px;
            background-color: #e5e7eb;
            /* OFF en claro */
            transition: background-color .18s ease, box-shadow .18s ease;
            vertical-align: middle;
            cursor: pointer;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.06);
        }

        input[type="checkbox"].peer+div::after {
            content: "";
            position: absolute;
            top: 0.125rem;
            left: 0.125rem;
            width: 1.125rem;
            /* knob */
            height: 1.125rem;
            background: #ffffff;
            border-radius: 9999px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.16);
            transition: transform .18s cubic-bezier(.4, 0, .2, 1), background-color .18s;
            transform: translateX(0);
        }

        /* Estado ON (fuerte contraste) */
        input[type="checkbox"].peer:checked+div {
            background-color: var(--accent) !important;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.08) inset;
        }

        input[type="checkbox"].peer:checked+div::after {
            /* Mover knob a la derecha; valor fijo para evitar problemas con utilidades tailwind */
            transform: translateX(1.55rem) !important;
            background: #ffffff !important;
        }

        /* Dark theme: estados más contrastados */
        .dark input[type="checkbox"].peer+div {
            background-color: #374151;
            /* OFF oscuro */
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.6);
        }

        .dark input[type="checkbox"].peer+div::after {
            background: #0f1724;
            /* knob OFF oscuro para distinguir */
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        }

        .dark input[type="checkbox"].peer:checked+div {
            background-color: var(--accent) !important;
            /* ON azul legible */
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1) inset;
        }

        .dark input[type="checkbox"].peer:checked+div::after {
            transform: translateX(1.55rem) !important;
            background: #ffffff !important;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.12);
        }

        /* Foco visible accesible */
        input[type="checkbox"].peer:focus+div,
        input[type="checkbox"].peer:focus-visible+div {
            outline: 3px solid rgba(37, 99, 235, 0.16);
            outline-offset: 3px;
        }

        /* Scrollbar personalizado */
        .main-content::-webkit-scrollbar {
            width: 6px;
        }

        .main-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .main-content::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        .dark .main-content::-webkit-scrollbar-thumb {
            background-color: #324153;
        }

        /* Sombra para botón central */
        .add-button-shadow {
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.28), 0 4px 6px -2px rgba(37, 99, 235, 0.12);
        }

        /* Asegurar que el main haga scroll correctamente dentro del contenedor flex */
        .mobile-screen main {
            flex: 1 1 auto;
            min-height: 0;
            /* importante para overflow en flex */
            overflow-y: auto;
        }

        /* Adaptaciones para safe-area y móviles pequeños */
        @media (max-width: 420px),
        (max-height: 800px) {
            .mobile-frame {
                width: 100vw;
                height: 100vh;
                max-height: 100vh;
                margin: 0;
                border-radius: 0;
                padding: env(safe-area-inset-top, 12px) env(safe-area-inset-right, 12px) env(safe-area-inset-bottom, 12px) env(safe-area-inset-left, 12px);
            }

            .mobile-screen {
                border-radius: 0;
            }

            footer.nav-bar {
                padding-bottom: env(safe-area-inset-bottom, 12px);
            }

            .mobile-screen main {
                padding-bottom: calc(72px + env(safe-area-inset-bottom, 0px));
            }
        }

        /* ---------- OVERRIDES PARA UTILITARIOS TAILWIND EN TEMA OSCURO ---------- */
        /* Convertir bg-white/bg-gray-* a superficies oscuras dentro de .dark */
        .dark .bg-white {
            background-color: var(--bg-elevated) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-dark) !important;
        }

        .dark .bg-gray-50 {
            background-color: #07101a !important;
        }

        .dark .bg-gray-100 {
            background-color: #0b1724 !important;
        }

        .dark .bg-gray-200 {
            background-color: #0f1b2a !important;
        }

        /* Texto: sustituir utilitarios grises por tonos apropiados en oscuro */
        .dark .text-gray-800,
        .dark .text-gray-700 {
            color: var(--text-primary) !important;
        }

        .dark .text-gray-600 {
            color: #9aa4b2 !important;
        }

        .dark .text-gray-500 {
            color: var(--text-secondary) !important;
        }

        .dark .text-gray-400 {
            color: #6b7280 !important;
        }

        /* Bordes en utilitarios */
        .dark .border-gray-200 {
            border-color: var(--border-dark) !important;
        }

        .dark .border {
            border-color: var(--border-dark) !important;
        }

        /* Inputs con bg-white forzados a bg oscuro */
        .dark input.bg-white,
        .dark textarea.bg-white,
        .dark select.bg-white {
            background-color: var(--input-bg-dark) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-dark) !important;
        }

        /* Botones y elementos interactivos suaves */
        .dark .hover\:bg-gray-50:hover {
            background-color: rgba(255, 255, 255, 0.02) !important;
        }

        .dark .hover\:bg-gray-200:hover {
            background-color: rgba(255, 255, 255, 0.03) !important;
        }

        /* Modales */
        .dark .w-full.max-w-md.mx-auto.mt-auto.bg-white {
            background-color: var(--bg-elevated) !important;
            color: var(--text-primary) !important;
        }

        .dark .w-full.max-w-sm.p-6.bg-white {
            background-color: var(--bg-elevated) !important;
            color: var(--text-primary) !important;
        }

        /* Mantener acento azul legible */
        .dark .bg-blue-500 {
            background-color: var(--accent) !important;
        }

        .dark .text-blue-600 {
            color: var(--accent) !important;
        }

        /* Botón cerrar sesión: solo borde rojo en oscuro */
        .dark .logout-btn {
            background: transparent !important;
            color: var(--text-primary) !important;
            border: 2px solid #ef4444 !important;
        }

        .dark .logout-btn:hover {
            background: rgba(239, 68, 68, 0.08) !important;
        }
    </style>
</head>

<body class="bg-gray-200">

    <div class="mobile-frame" id="app-frame">
        <div class="mobile-screen">
            <!-- PANTALLA LOGIN SIMPLE -->
            <div id="screen-login" class="p-8 flex flex-col items-center justify-center min-h-full"
                style="display:none;">
                <div class="w-full max-w-xs bg-white dark:bg-gray-800 rounded-xl shadow p-6">
                    <h2
                        class="text-3xl font-extrabold mb-5 text-center text-blue-700 dark:text-blue-400 tracking-tight">
                        DFind</h2>
                    <h3 class="text-lg font-semibold mb-6 text-center text-gray-700 dark:text-gray-200">Iniciar Sesión
                    </h3>
                    <div class="mb-4 w-full">
                        <label
                            class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 pl-1">Usuario</label>
                        <input id="login-username" type="text"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-900 dark:text-white text-base"
                            placeholder="Usuario" autocomplete="username">
                    </div>
                    <div class="mb-2 w-full relative">
                        <label
                            class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 pl-1">Contraseña</label>
                        <input id="login-password" type="password"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 dark:bg-gray-900 dark:text-white text-base pr-10"
                            placeholder="Contraseña" autocomplete="current-password">
                        <button id="toggle-password" type="button" tabindex="-1"
                            class="absolute right-3 top-8 transform -translate-y-1/2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400"
                            style="background: none; border: none; padding: 0; cursor: pointer;">
                            <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                        </button>
                    </div>
                    <button id="login-btn"
                        class="w-full py-2 mt-4 font-bold text-white bg-blue-600 rounded-lg shadow hover:bg-blue-700 transition-all text-base">Entrar</button>
                    <p id="login-error" class="mt-3 text-center text-red-500 text-sm hidden">Usuario o contraseña
                        incorrectos.</p>
                    <div class="mt-4 text-xs text-gray-400 text-center">Usuario: <span
                            class="font-semibold text-gray-600 dark:text-gray-200">Sebas</span> | Contraseña: <span
                            class="font-semibold text-gray-600 dark:text-gray-200">12345</span></div>
                </div>
            </div>
            <!-- Contenido principal que cambia -->
            <main class="flex-grow overflow-y-auto main-content">
                <!-- PANTALLA DE INICIO (DASHBOARD) -->
                <div id="screen-home" class="p-4 space-y-6">
                    <header class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400">Hola, </p>
                            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Carlos</h1>
                        </div>
                        <!-- Avatar/logo clickable to go to profile -->
                        <div id="user-avatar" class="flex items-center cursor-pointer">
                            <div
                                class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-600 text-white font-bold text-lg shadow">
                                C</div>
                        </div>
                    </header>

                    <!-- Barra de Búsqueda -->
                    <div class="relative">
                        <input id="search-input" type="text" placeholder="¿Qué estás buscando?"
                            class="w-full py-3 pl-10 pr-4 text-gray-700 bg-white border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        <svg class="absolute w-5 h-5 text-gray-400 left-3 top-3.5" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>

                    <!-- Alertas Próximas -->
                    <div>
                        <h2 class="mb-3 text-lg font-semibold text-gray-800 dark:text-white">Alertas Próximas</h2>
                        <div class="space-y-3">
                            <div
                                class="flex items-center p-3 space-x-3 bg-white border border-gray-200 rounded-lg shadow-sm cursor-pointer card home-alert-card">
                                <div class="p-2 bg-red-100 rounded-full"><svg class="w-6 h-6 text-red-500" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg></div>
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-gray-100">Leche caduca mañana</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Despensa, Casa Principal</p>
                                </div>
                            </div>
                            <div
                                class="flex items-center p-3 space-x-3 bg-white border border-gray-200 rounded-lg shadow-sm cursor-pointer card home-alert-card">
                                <div class="p-2 bg-yellow-100 rounded-full"><svg class="w-6 h-6 text-yellow-500"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z">
                                        </path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg></div>
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-gray-100">Mantenimiento aire
                                        acondicionado</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">En 5 días</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Añadidos Recientemente -->
                    <div>
                        <h2 class="mb-3 text-lg font-semibold text-gray-800 dark:text-white">Añadido Recientemente</h2>
                        <div class="grid grid-cols-2 gap-6 justify-items-center items-center pb-4 px-4">
                            <div class="w-32 text-center">
                                <div class="w-32 h-32 mb-2 overflow-hidden bg-gray-200 rounded-lg">
                                    <img src="img/taladro.jpg" alt="Taladro" class="object-cover w-full h-full">
                                </div>
                                <p class="text-sm font-medium text-gray-700 truncate dark:text-gray-200">Taladro Inalámbrico</p>
                            </div>
                            <div class="w-32 text-center">
                                <div class="w-32 h-32 mb-2 overflow-hidden bg-gray-200 rounded-lg">
                                    <img src="img/pasaporte.jpg" alt="Pasaporte" class="object-cover w-full h-full">
                                </div>
                                <p class="text-sm font-medium text-gray-700 truncate dark:text-gray-200">Pasaporte</p>
                            </div>
                            <div class="w-32 text-center">
                                <div class="w-32 h-32 mb-2 overflow-hidden bg-gray-200 rounded-lg">
                                    <img src="img/tele.jpg" alt="Televisión" class="object-cover w-full h-full">
                                </div>
                                <p class="text-sm font-medium text-gray-700 truncate dark:text-gray-200">Televisión Salón</p>
                            </div>
                            <div class="w-32 text-center">
                                <div class="w-32 h-32 mb-2 overflow-hidden bg-gray-200 rounded-lg">
                                    <img src="img/libro.jpg" alt="Libro" class="object-cover w-full h-full">
                                </div>
                                <p class="text-sm font-medium text-gray-700 truncate dark:text-gray-200">Libro 'El Hobbit'</p>
                            </div>
                        </div>
                    </div>

                    <!-- Categorías -->
                    <div class="hidden">
                        <div class="flex items-center justify-between mb-3">
                            <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Categorías</h2>
                            <button id="add-category-header-btn"
                                class="p-1 text-blue-600 rounded-full hover:bg-blue-100 dark:hover:bg-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="home-categories-list" class="grid grid-cols-1 gap-4 pb-4 px-2 sm:grid-cols-2">
                            <!-- Las categorías se cargarán aquí por JS -->
                        </div>
                    </div>
                </div>

                <!-- PANTALLA DE INVENTARIO -->
                <div id="screen-inventory" class="hidden p-4">
                    <div id="inventory-nav-header" class="flex items-center mb-4">
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Inventario</h1>
                    </div>
                    <div id="inventory-content" class="space-y-3">
                        <!-- El contenido se generará con JS -->
                    </div>
                </div>

                <!-- PANTALLA DE RESULTADOS DE BÚSQUEDA -->
                <div id="screen-search-results" class="hidden p-4">
                    <div id="search-nav-header" class="flex items-center mb-4">
                        <button id="search-back-btn"
                            class="p-2 mr-3 -ml-2 text-gray-600 rounded-full hover:bg-gray-200 dark:text-gray-300 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Resultados de Búsqueda</h1>
                    </div>
                    <div id="search-results-content" class="space-y-3">
                        <!-- Los resultados de la búsqueda aparecerán aquí -->
                    </div>
                </div>

                <!-- PANTALLA DE ALERTAS (NUEVA LÓGICA) -->
                <div id="screen-alerts" class="hidden p-4 pb-24">
                    <div class="flex items-center justify-between mb-4">
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">
                            Alertas
                        </h1>
                        <button id="alert-edit-btn"
                            class="hidden px-4 py-2 text-sm font-semibold text-blue-600 bg-blue-100 rounded-lg dark:bg-blue-900 dark:text-blue-200">
                            Seleccionar
                        </button>
                    </div>

                    <div class="flex mb-4 border-b border-gray-200 dark:border-gray-700">
                        <button id="alert-tab-actuales" data-tab="actuales"
                            class="flex-1 py-2 font-semibold text-blue-600 border-b-2 border-blue-600 alert-tab">
                            Actuales
                        </button>
                        <button id="alert-tab-past" data-tab="past"
                            class="flex-1 py-2 font-semibold text-gray-500 alert-tab dark:text-gray-400">
                            Pasadas
                        </button>
                    </div>

                    <div id="alert-list-actuales" class="space-y-6 alert-list">
                        <div>
                            <h2 class="mb-3 text-lg font-semibold text-gray-800 dark:text-white">Importantes</h2>
                            <div id="alert-list-importantes" class="space-y-3">
                            </div>
                        </div>
                        <div>
                            <h2 class="mb-3 text-lg font-semibold text-gray-800 dark:text-white">Próximas</h2>
                            <div id="alert-list-proximas" class="space-y-3">
                            </div>
                        </div>
                        <div>
                            <h2 class="mb-3 text-lg font-semibold text-gray-500 dark:text-gray-400">Desactivadas</h2>
                            <div id="alert-list-desactivadas" class="space-y-3">
                            </div>
                        </div>
                    </div>

                    <div id="alert-list-past" class="hidden space-y-3 alert-list">
                        <!-- Alertas pasadas se renderizarán aquí -->
                    </div>
                </div>


                <!-- PANTALLA DE PERFIL -->
                <div id="screen-profile" class="hidden">
                    <div class="h-32 bg-blue-500"></div>
                    <div class="p-4 -mt-16">
                        <div class="flex flex-col items-center mb-6">
                            <div
                                class="w-24 h-24 mb-2 bg-gray-300 rounded-full overflow-hidden ring-4 ring-white dark:ring-gray-800">
                                <img src="https://placehold.co/100x100/E2E8F0/4A5568?text=C" alt="Avatar de usuario"
                                    class="object-cover w-full h-full">
                            </div>
                            <h1 class="text-xl font-bold">Carlos Rodríguez</h1>
                            <p class="text-sm text-gray-500">carlos.r@email.com</p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <h3 class="px-2 mb-2 text-sm font-semibold text-gray-500">Gestión</h3>
                                <div class="bg-white rounded-lg shadow-sm card">
                                    <button id="nav-to-properties"
                                        class="flex items-center justify-between w-full p-4 text-left border-b dark:border-gray-600">
                                        <span>Mis Propiedades</span>
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                    <button id="nav-to-categories"
                                        class="flex items-center justify-between w-full p-4 text-left">
                                        <span>Mis Categorías</span>
                                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5l7 7-7 7"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h3 class="px-2 mb-2 text-sm font-semibold text-gray-500">Configuración</h3>
                                <div class="bg-white rounded-lg shadow-sm card">
                                    <div class="flex items-center justify-between p-4 border-b dark:border-gray-600">
                                        <span>Notificaciones</span>
                                        <label class="relative inline-flex items-center cursor-pointer"><input
                                                type="checkbox" value="" class="sr-only peer" checked>
                                            <div
                                                class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
                                            </div>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between p-4">
                                        <span>Tema Oscuro</span>
                                        <label class="relative inline-flex items-center cursor-pointer"><input
                                                type="checkbox" id="theme-toggle" class="sr-only peer">
                                            <div
                                                class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600">
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <button
                                class="w-full py-3 font-semibold text-red-600 bg-white border border-red-200 rounded-lg card logout-btn">Cerrar
                                Sesión</button>
                        </div>
                    </div>
                </div>

                <!-- PANTALLA CRUD MIS PROPIEDADES -->
                <div id="screen-properties" class="hidden p-4">
                    <div class="flex items-center mb-4">
                        <button id="properties-back-btn"
                            class="p-2 mr-3 -ml-2 text-gray-600 rounded-full hover:bg-gray-200 dark:text-gray-300 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Mis Propiedades</h1>
                    </div>
                    <div id="properties-list" class="space-y-3">
                        <!-- Lista de propiedades se generará aquí -->
                    </div>
                    <button id="add-property-crud-btn"
                        class="w-full py-3 mt-4 font-semibold text-blue-600 border-2 border-blue-500 border-dashed rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700">
                        + Añadir Propiedad
                    </button>
                </div>

                <!-- PANTALLA CRUD MIS CATEGORÍAS -->
                <div id="screen-categories" class="hidden p-4">
                    <div class="flex items-center mb-4">
                        <button id="categories-back-btn"
                            class="p-2 mr-3 -ml-2 text-gray-600 rounded-full hover:bg-gray-200 dark:text-gray-300 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Mis Categorías</h1>
                    </div>
                    <div id="categories-list" class="space-y-3">
                        <!-- Lista de categorías se generará aquí -->
                    </div>
                    <button id="add-category-crud-btn"
                        class="w-full py-3 mt-4 font-semibold text-blue-600 border-2 border-blue-500 border-dashed rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700">
                        + Añadir Categoría
                    </button>
                </div>

                <!-- MODAL PARA AÑADIR OBJETO -->
                <div id="modal-add-object" class="fixed inset-0 z-50 flex-col hidden bg-gray-900 bg-opacity-75">
                    <div class="w-full h-full max-w-md mx-auto mt-auto bg-white rounded-t-2xl dark:bg-gray-800">
                        <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
                            <h2 class="text-xl font-bold">Añadir Nuevo Objeto</h2>
                            <button id="close-modal-btn" class="text-gray-500 text-3xl leading-none">&times;</button>
                        </div>
                        <div class="p-4 space-y-4 overflow-y-auto" style="max-height: calc(100% - 120px);">
                            <!-- Paso 1 -->
                            <div>
                                <label class="font-semibold">1. ¿Qué es?</label>
                                <div
                                    class="flex items-center justify-center w-full h-32 mt-2 bg-gray-100 border-2 border-dashed rounded-lg dark:bg-gray-700 dark:border-gray-600">
                                    <div class="text-center text-gray-500">
                                        <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                                            </path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        <p>Tocar para añadir foto</p>
                                    </div>
                                </div>
                                <input id="modal-object-name" type="text" placeholder="* Nombre del Objeto"
                                    class="w-full p-2 mt-2 border rounded">
                                <textarea placeholder="Descripción (opcional)" class="w-full p-2 mt-2 border rounded"
                                    rows="2"></textarea>
                                <select class="w-full p-2 mt-2 border rounded">
                                    <option>Seleccionar Categoría</option>
                                    <option>Electrónica</option>
                                    <option>Documentos</option>
                                    <option>Herramientas</option>
                                    <option>Alimentos</option>
                                </select>
                            </div>
                            <!-- Paso 2 y 3 -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="font-semibold">2. Cantidad</label>
                                    <input type="number" value="1" class="w-full p-2 mt-2 border rounded">
                                </div>
                                <div>
                                    <label class="font-semibold">Unidad</label>
                                    <select class="w-full p-2 mt-2 border rounded">
                                        <option>Unidades</option>
                                        <option>kg</option>
                                        <option>Litros</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="font-semibold">3. ¿Dónde está?</label>
                                <select class="w-full p-2 mt-2 border rounded">
                                    <option>Casa Principal > Cocina > Despensa</option>
                                    <option>Casa Principal > Garaje > Caja Herramientas</option>
                                    <option>Oficina > Escritorio > Cajón 1</option>
                                </select>
                            </div>
                            <!-- Pasos opcionales -->
                            <div>
                                <details>
                                    <summary class="font-semibold text-blue-600 cursor-pointer">Detalles y Alertas
                                        (Opcional)</summary>
                                    <div class="p-3 mt-2 space-y-4 bg-gray-50 rounded-lg dark:bg-gray-700">
                                        <input type="number" placeholder="Costo" class="w-full p-2 border rounded">
                                        <div>
                                            <label class="text-sm text-gray-600 dark:text-gray-300">Fecha de
                                                compra</label>
                                            <input type="date" class="w-full p-2 border rounded">
                                        </div>
                                        <button
                                            class="w-full py-2 text-sm font-semibold text-blue-600 border-2 border-blue-500 border-dashed rounded-lg">+
                                            Añadir Alerta</button>
                                    </div>
                                </details>
                            </div>
                        </div>
                        <div class="p-4">
                            <button id="save-object-btn"
                                class="w-full py-3 font-bold text-white bg-blue-600 rounded-lg">Guardar Objeto</button>
                        </div>
                    </div>
                </div>

                <!-- MODAL PARA AÑADIR ELEMENTO GENÉRICO (Propiedad, Habitación, etc.) -->
                <div id="modal-add-generic"
                    class="fixed inset-0 z-50 items-center justify-center hidden bg-gray-900 bg-opacity-75">
                    <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl dark:bg-gray-800">
                        <h2 id="modal-generic-title" class="mb-4 text-xl font-bold">Añadir Elemento</h2>
                        <input id="modal-generic-input" type="text" placeholder="Nombre del elemento"
                            class="w-full p-3 mb-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        <div class="flex justify-end space-x-3">
                            <button id="modal-generic-cancel"
                                class="px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancelar</button>
                            <button id="modal-generic-save"
                                class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Guardar</button>
                        </div>
                    </div>
                </div>

                <!-- NUEVO MODAL: AÑADIR/EDITAR ALERTA -->
                <div id="modal-add-alert" class="fixed inset-0 z-50 flex-col hidden bg-gray-900 bg-opacity-75">
                    <div class="w-full h-full max-w-md mx-auto mt-auto bg-white rounded-t-2xl dark:bg-gray-800">
                        <div class="flex items-center justify-between p-4 border-b dark:border-gray-700">
                            <h2 id="alert-modal-title" class="text-xl font-bold">Añadir Nueva Alerta</h2>
                            <button id="close-alert-modal-btn" class="text-gray-500 text-3xl leading-none">
                                &times;
                            </button>
                        </div>
                        <div class="p-4 space-y-4 overflow-y-auto" style="max-height: calc(100% - 120px)">
                            <div>
                                <label for="alert-title" class="text-sm font-medium">Título*</label>
                                <input id="alert-title" type="text" placeholder="Ej: Caducidad de la leche"
                                    class="w-full p-2 mt-1 border rounded" />
                            </div>
                            <div>
                                <label for="alert-description" class="text-sm font-medium">Descripción</label>
                                <textarea id="alert-description" placeholder="Descripción detallada (opcional)"
                                    class="w-full p-2 mt-1 border rounded" rows="2"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="alert-date" class="text-sm font-medium">Fecha*</label>
                                    <input id="alert-date" type="date" class="w-full p-2 mt-1 border rounded" />
                                </div>
                                <div>
                                    <label for="alert-priority" class="text-sm font-medium">Prioridad</label>
                                    <select id="alert-priority" class="w-full p-2 mt-1 border rounded">
                                        <option value="baja">Baja</option>
                                        <option value="media">Media</option>
                                        <option value="alta">Alta</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="alert-location" class="text-sm font-medium">Asociar a Ubicación
                                    (Opcional)</label>
                                <select id="alert-location" class="w-full p-2 mt-1 border rounded">
                                    <option value="">Ninguna</option>
                                </select>
                            </div>
                            <div>
                                <label for="alert-object" class="text-sm font-medium">Asociar a Objeto
                                    (Opcional)</label>
                                <select id="alert-object" class="w-full p-2 mt-1 border rounded">
                                    <option value="">Ninguno</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input id="alert-repetitive" type="checkbox"
                                        class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="alert-repetitive" class="ml-2 block text-sm">
                                        ¿Es una alerta repetitiva?
                                    </label>
                                </div>
                                <div id="alert-repeat-options" class="hidden pl-6">
                                    <label for="alert-repeat-frequency" class="text-sm font-medium">Repetir
                                        cada:</label>
                                    <select id="alert-repeat-frequency" class="w-full p-2 mt-1 border rounded">
                                        <option value="semanal">Semana</option>
                                        <option value="mensual">Mes</option>
                                        <option value="anual">Año</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="p-4">
                            <button id="save-alert-btn" class="w-full py-3 font-bold text-white bg-blue-600 rounded-lg">
                                Guardar Alerta
                            </button>
                        </div>
                    </div>
                </div>

                <!-- NUEVO MODAL: VER ALERTA -->
                <div id="modal-view-alert"
                    class="fixed inset-0 z-50 items-center justify-center hidden bg-gray-900 bg-opacity-75">
                    <div class="w-full max-w-sm p-6 bg-white rounded-lg shadow-xl dark:bg-gray-800">
                        <h2 id="view-alert-title" class="mb-2 text-xl font-bold">Título de la Alerta</h2>
                        <p id="view-alert-date" class="mb-4 text-sm text-gray-500 dark:text-gray-400">Fecha</p>
                        <p id="view-alert-description" class="mb-4">Descripción...</p>
                        <div id="view-alert-location" class="mb-4 text-sm"></div>

                        <div id="view-alert-buttons" class="flex flex-col space-y-3">
                            <button id="alert-modal-modify"
                                class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                                Modificar
                            </button>
                            <button id="alert-modal-deactivate"
                                class="w-full px-4 py-2 font-semibold text-white bg-yellow-500 rounded-lg hover:bg-yellow-600">
                                Desactivar
                            </button>
                            <button id="alert-modal-reactivate"
                                class="w-full px-4 py-2 font-semibold text-white bg-green-500 rounded-lg hover:bg-green-600">
                                Reactivar
                            </button>
                            <button id="alert-modal-delete"
                                class="w-full px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">
                                Eliminar
                            </button>
                            <button id="alert-modal-cancel"
                                class="w-full px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>

            </main>
            <!-- NUEVO BOTÓN FLOTANTE PARA ALERTAS -->
            <button id="open-alert-modal-btn" 
                class="fixed z-40 w-16 h-16 text-white bg-blue-600 rounded-full add-button-shadow bottom-24 right-6 hidden inline-flex items-center justify-center hover:bg-blue-700 transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" 
                    class="w-7 h-7" 
                    fill="none" 
                    viewBox="0 0 24 24" 
                    stroke="currentColor" 
                    stroke-width="2">
                    <path stroke-linecap="round" 
                        stroke-linejoin="round" 
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h11" />
                    <path stroke-linecap="round" 
                        stroke-linejoin="round" 
                        d="M12 17v1a2 2 0 104 0v-1" />
                </svg>
            </button>

            <!-- NUEVO FOOTER PARA SELECCIÓN DE ALERTAS -->
            <div id="alert-selection-footer"
                class="absolute bottom-20 left-0 right-0 z-40 hidden p-4 bg-white border-t border-gray-200 dark:bg-gray-800 dark:border-gray-700">
                <button id="alert-delete-selected-btn" class="w-full py-3 font-bold text-white bg-red-600 rounded-lg">
                    Eliminar Seleccionadas
                </button>
            </div>


            <!-- BARRA DE NAVEGACIÓN INFERIOR -->
            <footer
                class="relative z-50 flex-shrink-0 w-full bg-white border-t border-gray-200 nav-bar dark:bg-gray-800 dark:border-gray-700">
                <div class="flex items-center justify-around h-20">
                    <button data-screen="home"
                        class="p-2 text-center text-gray-500 rounded-lg nav-button active dark:text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                        <span class="text-xs">Inicio</span>
                    </button>
                    <button data-screen="inventory"
                        class="p-2 text-center text-gray-500 rounded-lg nav-button dark:text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4">
                            </path>
                        </svg>
                        <span class="text-xs">Inventario</span>
                    </button>
                    <button id="add-object-btn"
                        class="w-16 h-16 mb-8 text-white bg-blue-600 rounded-full add-button-shadow">
                        <svg class="w-8 h-8 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                    </button>
                    <button data-screen="alerts"
                        class="p-2 text-center text-gray-500 rounded-lg nav-button dark:text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                            </path>
                        </svg>
                        <span class="text-xs">Alertas</span>
                    </button>
                    <button data-screen="profile"
                        class="p-2 text-center text-gray-500 rounded-lg nav-button dark:text-gray-400">
                        <svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="text-xs">Perfil</span>
                    </button>
                </div>
            </footer>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- LOGIN STATE ---
            let isLoggedIn = true;
            const loginScreen = document.getElementById('screen-login');
            const mainScreens = document.querySelector('main');
            const loginBtn = document.getElementById('login-btn');
            const loginUsername = document.getElementById('login-username');
            const loginPassword = document.getElementById('login-password');
            const loginError = document.getElementById('login-error');

            function showLoginScreen() {
                isLoggedIn = false;
                loginScreen.style.display = '';
                mainScreens.style.display = 'none';
                loginUsername.value = '';
                loginPassword.value = '';
                loginError.classList.add('hidden');
                loginUsername.focus();
            }
            function hideLoginScreen() {
                isLoggedIn = true;
                loginScreen.style.display = 'none';
                mainScreens.style.display = '';
            }
            if (loginBtn) {
                loginBtn.addEventListener('click', function () {
                    const user = loginUsername.value.trim();
                    const pass = loginPassword.value;
                    if (user === 'Sebas' && pass === '12345') {
                        hideLoginScreen();
                        showScreen('home');
                    } else {
                        loginError.classList.remove('hidden');
                    }
                });
                loginPassword.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') loginBtn.click();
                });
                // Ojito para mostrar/ocultar contraseña
                const togglePassword = document.getElementById('toggle-password');
                const eyeIcon = document.getElementById('eye-icon');
                let passwordVisible = false;
                if (togglePassword) {
                    togglePassword.addEventListener('click', function () {
                        passwordVisible = !passwordVisible;
                        loginPassword.type = passwordVisible ? 'text' : 'password';
                        // Cambiar ícono si quieres (opcional: ojo abierto/cerrado)
                        eyeIcon.innerHTML = passwordVisible
                            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.978 9.978 0 012.042-3.362M6.634 6.634A9.953 9.953 0 0112 5c4.477 0 8.268 2.943 9.542 7a9.978 9.978 0 01-4.293 5.032M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3l18 18" />'
                            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
                    });
                }
            }
            // --- ELEMENTOS DEL DOM ---
            const navButtons = document.querySelectorAll('.nav-button');
            const screens = document.querySelectorAll('main > div:not([id^="modal-"])');
            const addObjectBtn = document.getElementById('add-object-btn');
            // --- AVATAR CLICK TO PROFILE ---
            const userAvatar = document.getElementById('user-avatar');
            if (userAvatar) {
                userAvatar.addEventListener('click', () => {
                    navigateToScreen('profile');
                });
            }
            const closeModalBtn = document.getElementById('close-modal-btn');
            const saveObjectBtn = document.getElementById('save-object-btn');
            const modal = document.getElementById('modal-add-object');
            const modalObjectNameInput = document.getElementById('modal-object-name');
            const modalAddGeneric = document.getElementById('modal-add-generic');
            const modalGenericTitle = document.getElementById('modal-generic-title');
            const modalGenericInput = document.getElementById('modal-generic-input');
            const modalGenericCancel = document.getElementById('modal-generic-cancel');
            const modalGenericSave = document.getElementById('modal-generic-save');
            const themeToggle = document.getElementById('theme-toggle');
            const appFrame = document.getElementById('app-frame');
            const inventoryContent = document.getElementById('inventory-content');
            const inventoryNavHeader = document.getElementById('inventory-nav-header');
            const searchInput = document.getElementById('search-input');
            const screenSearchResults = document.getElementById('screen-search-results');
            const searchResultsContent = document.getElementById('search-results-content');
            const searchBackBtn = document.getElementById('search-back-btn');
            const homeAlertCards = document.querySelectorAll('.home-alert-card');
            const addCategoryHeaderBtn = document.getElementById('add-category-header-btn');

            // --- Nuevos elementos CRUD Perfil ---
            const navToPropertiesBtn = document.getElementById('nav-to-properties');
            const navToCategoriesBtn = document.getElementById('nav-to-categories');
            const screenProperties = document.getElementById('screen-properties');
            const propertiesList = document.getElementById('properties-list');
            const propertiesBackBtn = document.getElementById('properties-back-btn');
            const addPropertyCrudBtn = document.getElementById('add-property-crud-btn');
            const screenCategories = document.getElementById('screen-categories');
            const categoriesList = document.getElementById('categories-list');
            const categoriesBackBtn = document.getElementById('categories-back-btn');
            const addCategoryCrudBtn = document.getElementById('add-category-crud-btn');

            // --- NUEVOS ELEMENTOS DE ALERTA ---
            const openAlertModalBtn = document.getElementById('open-alert-modal-btn');
            const modalAddAlert = document.getElementById('modal-add-alert');
            const closeAlertModalBtn = document.getElementById('close-alert-modal-btn');
            const saveAlertBtn = document.getElementById('save-alert-btn');
            const alertModalTitle = document.getElementById('alert-modal-title');
            const alertTitleInput = document.getElementById('alert-title');
            const alertDescriptionInput = document.getElementById('alert-description');
            const alertDateInput = document.getElementById('alert-date');
            const alertPriorityInput = document.getElementById('alert-priority');
            const alertLocationInput = document.getElementById('alert-location');
            const alertObjectInput = document.getElementById('alert-object');
            const alertRepetitiveCheckbox = document.getElementById('alert-repetitive');
            const alertRepeatOptions = document.getElementById('alert-repeat-options');
            const alertTabs = document.querySelectorAll('.alert-tab');
            const alertLists = document.querySelectorAll('.alert-list');
            const alertEditBtn = document.getElementById('alert-edit-btn');
            const alertSelectionFooter = document.getElementById('alert-selection-footer');
            const alertDeleteSelectedBtn = document.getElementById('alert-delete-selected-btn');
            const listActuales = document.getElementById('alert-list-actuales');
            const listImportantes = document.getElementById('alert-list-importantes');
            const listProximas = document.getElementById('alert-list-proximas');
            const listDesactivadas = document.getElementById('alert-list-desactivadas');
            const listPast = document.getElementById('alert-list-past');
            const modalViewAlert = document.getElementById('modal-view-alert');
            const viewAlertTitle = document.getElementById('view-alert-title');
            const viewAlertDate = document.getElementById('view-alert-date');
            const viewAlertDescription = document.getElementById('view-alert-description');
            const viewAlertLocation = document.getElementById('view-alert-location');
            const alertModalModify = document.getElementById('alert-modal-modify');
            const alertModalDeactivate = document.getElementById('alert-modal-deactivate');
            const alertModalReactivate = document.getElementById('alert-modal-reactivate');
            const alertModalDelete = document.getElementById('alert-modal-delete');
            const alertModalCancel = document.getElementById('alert-modal-cancel');


            // --- BASE DE DATOS (FUSIONADA) ---
            const inventoryDB = {
                'propiedades': [
                    { id: 'prop1', nombre: 'Casa Principal', icono: '🏠', children: ['hab1', 'hab2', 'hab3'] },
                    { id: 'prop2', nombre: 'Apartamento de Playa', icono: '🏖️', children: ['hab4'] },
                    { id: 'prop3', nombre: 'Oficina', icono: '🏢', children: ['obj_laptop'] }, // Objeto directo
                ],
                'habitaciones': {
                    'hab1': { nombre: 'Cocina', parent: 'prop1', children: ['alm1', 'obj1'], icono: '🧑‍🍳' },
                    'hab2': { nombre: 'Dormitorio Principal', parent: 'prop1', children: ['alm2', 'obj_ac'], icono: '🛏️' },
                    'hab3': { nombre: 'Garaje', parent: 'prop1', children: ['alm3', 'obj2'], icono: '🚗' },
                    'hab4': { nombre: 'Salón', parent: 'prop2', children: [] },
                },
                'almacenamientos': {
                    'alm1': { nombre: 'Despensa', parent: 'hab1', children: ['obj3', 'obj4', 'obj_leche'] },
                    'alm2': { nombre: 'Armario Ropa', parent: 'hab2', children: [], icono: '👗' },
                    'alm3': { nombre: 'Caja Herramientas', parent: 'hab3', children: ['obj5'] },
                },
                'objetos': {
                    'obj1': { nombre: 'Televisión', parent: 'hab1', img: 'tele.jpg', icono: '📺' },
                    'obj2': { nombre: 'Bicicleta', parent: 'hab3', img: 'bici.jpg', icono: '🚲' },
                    'obj3': { nombre: 'Latas de atún', parent: 'alm1', img: 'atun.jpg' },
                    'obj4': { nombre: 'Paquete de arroz', parent: 'alm1', img: 'arroz.jpg' },
                    'obj5': { nombre: 'Taladro Inalámbrico', parent: 'alm3', img: 'taladro.jpg', icono: '🛠️' },
                    'obj6': { nombre: 'Cámara de fotos', parent: 'hab2', img: 'camara.jpg' },
                    'obj7': { nombre: 'Libro de recetas', parent: 'hab1', img: 'libro.jpg' },
                    'obj8': { nombre: 'Jarrón decorativo', parent: 'hab4', img: 'jarron.jpg' },
                    'obj_leche': { nombre: 'Leche Entera', parent: 'alm1', img: 'leche.jpg' },
                    'obj_ac': { nombre: 'Aire Acondicionado Split', parent: 'hab2', img: 'aire.jpg', icono: '❄️' },
                    'obj_laptop': { nombre: 'MacBook Pro 14"', parent: 'prop3', img: 'laptop.jpg' }
                },
                'categorias': [
                    { id: 'cat1', nombre: 'Electrónica' },
                    { id: 'cat2', nombre: 'Documentos' },
                    { id: 'cat3', nombre: 'Herramientas' },
                ]
            };

            // --- NUEVA DB DE ALERTAS ---
            let alertsDB = [
                { id: 'alert1', title: 'Leche caduca mañana', description: 'Revisar la leche en la nevera.', priority: 'alta', locationId: 'alm1', objectId: 'obj_leche', date: '2025-10-24', repetitive: false, repeatFrequency: null, active: true },
                { id: 'alert4', title: 'Pagar servicio de luz', description: 'Factura de luz vence hoy.', priority: 'alta', locationId: 'prop1', objectId: '', date: '2025-10-23', repetitive: false, repeatFrequency: null, active: true }, // Ejemplo Importante
                { id: 'alert2', title: 'Mantenimiento aire acondicionado', description: 'Llamar al técnico.', priority: 'media', locationId: 'hab2', objectId: 'obj_ac', date: '2025-10-28', repetitive: true, repeatFrequency: 'anual', active: true }, // Ejemplo Próxima (Media)
                { id: 'alert3', title: 'Garantía del portátil vence', description: '', priority: 'baja', locationId: 'prop3', objectId: 'obj_laptop', date: '2025-12-23', repetitive: false, repeatFrequency: null, active: true }, // Ejemplo Próxima (Baja)
                { id: 'alert6', title: 'Comprar pienso del perro', description: 'Se está acabando.', priority: 'media', locationId: 'alm1', objectId: '', date: '2025-11-01', repetitive: true, repeatFrequency: 'mensual', active: false }, // Ejemplo Desactivada
                { id: 'alert5', title: 'Revisión del coche', description: 'Revisión de los 50,000km.', priority: 'media', locationId: 'hab3', objectId: '', date: '2025-10-15', repetitive: false, repeatFrequency: null, active: true }, // Ejemplo Pasada
                { id: 'alert7', title: 'Pagar tarjeta crédito', description: '', priority: 'alta', locationId: '', objectId: '', date: '2025-09-30', repetitive: false, repeatFrequency: null, active: true }, // Ejemplo Pasada (Alta)
            ];

            // --- ESTADO GLOBAL ---
            let navStack = []; // Pila para el historial de navegación
            let currentAlertTab = 'actuales';
            let alertSelectionMode = false;
            let today = new Date().toISOString().split('T')[0];


            // --- NAVEGACIÓN PRINCIPAL ---
            const activeNavButtonClass = 'active';
            const activeTextColorClass = 'text-blue-600';
            const inactiveTextColorClass = 'text-gray-500';
            const darkInactiveTextColorClass = 'dark:text-gray-400';

            function hideAllScreens() {
                screens.forEach(s => s.classList.add('hidden'));
            }

            // --- showScreen (FUSIONADA) ---
            function showScreen(screenId) {
                hideAllScreens();
                const screenToShow = document.getElementById(`screen-${screenId}`);
                if (screenToShow) {
                    screenToShow.classList.remove('hidden');
                }

                // Lógica específica de pantalla
                if (screenId === 'alerts') {
                    renderAlertsScreen();
                    openAlertModalBtn.classList.remove('hidden');
                    // Mostrar/ocultar footer de selección solo si estamos en 'past' y modo edición
                    alertSelectionFooter.classList.toggle('hidden', !(alertSelectionMode && currentAlertTab === 'past'));
                } else {
                    openAlertModalBtn.classList.add('hidden');
                    alertSelectionFooter.classList.add('hidden');
                    // Si salimos de la pantalla de alertas, cancelamos el modo edición
                    if (alertSelectionMode) {
                        toggleAlertSelectionMode(false); // Forzar salida del modo edición
                    }
                }
            }

            function navigateToScreen(screenId) {
                showScreen(screenId);
                navButtons.forEach(btn => {
                    btn.classList.remove(activeTextColorClass, activeNavButtonClass);
                    btn.classList.add(inactiveTextColorClass, darkInactiveTextColorClass);
                });
                const buttonToActivate = document.querySelector(`.nav-button[data-screen="${screenId}"]`);
                if (buttonToActivate) {
                    buttonToActivate.classList.add(activeTextColorClass, activeNavButtonClass);
                    buttonToActivate.classList.remove(inactiveTextColorClass, darkInactiveTextColorClass);
                }
            }

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const screenId = button.dataset.screen;
                    navigateToScreen(screenId);
                });
            });

            // --- NAVEGACIÓN DESDE ALERTAS HOME ---
            homeAlertCards.forEach(card => {
                card.addEventListener('click', () => {
                    navigateToScreen('alerts');
                });
            });


            // --- MODALES (Genérico y Objeto) ---
            addObjectBtn.addEventListener('click', (e) => {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            });

            closeModalBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });

            function openAddCategoryModal() {
                modalGenericTitle.textContent = 'Añadir Nueva Categoría';
                modalGenericInput.placeholder = 'Nombre de la categoría';
                modalAddGeneric.dataset.addType = 'categoria';
                modalAddGeneric.dataset.parentId = null;
                modalAddGeneric.classList.remove('hidden');
                modalAddGeneric.classList.add('flex');
                modalGenericInput.focus();
            }

            addCategoryHeaderBtn.addEventListener('click', openAddCategoryModal);

            function hideGenericModal() {
                modalAddGeneric.classList.add('hidden');
                modalAddGeneric.classList.remove('flex');
                modalGenericInput.value = '';
                delete modalAddGeneric.dataset.editId;
                delete modalAddGeneric.dataset.addType;
                delete modalAddGeneric.dataset.parentId;
            }
            modalGenericCancel.addEventListener('click', hideGenericModal);

            // --- TEMA OSCURO ---
            themeToggle.addEventListener('change', () => {
                appFrame.classList.toggle('dark');
            });

            // --- getFullPath (VERSIÓN MEJORADA DEL USUARIO) ---
            function getFullPath(type, id) {
                let path = []
                let currentId = id
                let currentType = type
                let loops = 0; // Safety break

                while (currentId && loops < 10) {
                    loops++;
                    let item
                    if (currentType === 'propiedades') {
                        item = inventoryDB.propiedades.find(p => p.id === currentId)
                        if (item) path.unshift(item.nombre)
                        currentId = null
                    } else if (currentType === 'habitaciones') {
                        item = inventoryDB.habitaciones[currentId];
                        if (item) {
                            path.unshift(item.nombre);
                            currentId = item.parent;
                            currentType = 'propiedades';
                        } else {
                            currentId = null;
                        }
                    } else if (currentType === 'almacenamientos') {
                        item = inventoryDB.almacenamientos[currentId];
                        if (item) {
                            path.unshift(item.nombre);
                            currentId = item.parent;
                            currentType = 'habitaciones';
                        } else {
                            currentId = null;
                        }
                    } else if (currentType === 'objetos') {
                        item = inventoryDB.objetos[currentId];
                        if (item) {
                            currentId = item.parent;
                            if (inventoryDB.almacenamientos[currentId]) currentType = 'almacenamientos';
                            else if (inventoryDB.habitaciones[currentId]) currentType = 'habitaciones';
                            else if (inventoryDB.propiedades.find(p => p.id === currentId)) currentType = 'propiedades';
                            else currentId = null;
                        } else {
                            currentId = null;
                        }
                    } else {
                        currentId = null;
                    }
                }
                return path.join(' > ')
            }

            // --- modalGenericSave (NUESTRA VERSIÓN CON CRUD) ---
            modalGenericSave.addEventListener('click', () => {
                const newItemName = modalGenericInput.value;
                const addType = modalAddGeneric.dataset.addType;
                const parentId = modalAddGeneric.dataset.parentId;

                if (newItemName && newItemName.trim() !== '') {
                    const trimmedName = newItemName.trim();
                    const newId = `${addType.substring(0, 3)}${Date.now()}`;
                    switch (addType) {
                        case 'propiedad':
                            inventoryDB.propiedades.push({ id: newId, nombre: trimmedName, icono: '🏠', children: [] });
                            hideGenericModal();
                            if (!screenProperties.classList.contains('hidden')) {
                                renderPropertiesCRUD();
                            }
                            if (!screenInventory.classList.contains('hidden')) {
                                renderInventory('propiedades');
                            }
                            return;
                        case 'propiedad_edit':
                            const propToEdit = inventoryDB.propiedades.find(p => p.id === modalAddGeneric.dataset.editId);
                            if (propToEdit) propToEdit.nombre = trimmedName;
                            renderPropertiesCRUD();
                            break;
                        case 'habitacion':
                            inventoryDB.habitaciones[newId] = { nombre: trimmedName, parent: parentId, children: [] };
                            inventoryDB.propiedades.find(p => p.id === parentId).children.push(newId);
                            renderInventory('habitaciones', parentId);
                            break;
                        case 'almacenamiento':
                            inventoryDB.almacenamientos[newId] = { nombre: trimmedName, parent: parentId, children: [] };
                            inventoryDB.habitaciones[parentId].children.push(newId);
                            renderInventory('contenidos', parentId);
                            break;
                        case 'categoria':
                            const newCatId = `cat${Date.now()}`;
                            inventoryDB.categorias.push({ id: newCatId, nombre: trimmedName });
                            renderHomeCategories();
                            if (!screenCategories.classList.contains('hidden')) {
                                renderCategoriesCRUD();
                            }
                            break;
                        case 'categoria_edit':
                            const catToEdit = inventoryDB.categorias.find(c => c.id === modalAddGeneric.dataset.editId);
                            if (catToEdit) catToEdit.nombre = trimmedName;
                            renderCategoriesCRUD();
                            renderHomeCategories();
                            break;
                    }
                }
                hideGenericModal();
            });

            // --- saveObjectBtn (NUESTRA VERSIÓN) ---
            saveObjectBtn.addEventListener('click', () => {
                const objectName = modalObjectNameInput.value;
                const parentId = modal.dataset.parentId; // Esto se debe setear al abrir el modal desde inventario

                if (objectName && objectName.trim() !== '' && parentId) {
                    const trimmedName = objectName.trim();
                    const newId = `obj${Date.now()}`;

                    inventoryDB.objetos[newId] = { nombre: trimmedName, parent: parentId };

                    if (inventoryDB.almacenamientos[parentId]) {
                        inventoryDB.almacenamientos[parentId].children.push(newId);
                    } else if (inventoryDB.habitaciones[parentId]) {
                        inventoryDB.habitaciones[parentId].children.push(newId);
                    }

                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modalObjectNameInput.value = '';

                    const currentState = navStack[navStack.length - 1] || { level: 'propiedades', id: null };
                    renderInventory(currentState.level, currentState.id);
                } else if (!parentId) {
                    console.error("Error: parentId no está definido en el modal. El modal debe ser abierto desde un contexto.");
                    modalObjectNameInput.classList.add('border-red-500', 'ring-red-500');
                } else {
                    modalObjectNameInput.classList.add('border-red-500', 'ring-red-500');
                    setTimeout(() => modalObjectNameInput.classList.remove('border-red-500', 'ring-red-500'), 2000);
                }
            });

            // --- LÓGICA DE INVENTARIO (NUESTRA VERSIÓN) ---
            function renderInventory(level, id) {
                inventoryContent.innerHTML = '';
                let items = [];
                let title = 'Inventario';

                if (level === 'propiedades') {
                    items = inventoryDB.propiedades.map(p => ({ ...p, tipo: 'propiedad' }));
                    title = 'Propiedades';
                } else if (level === 'habitaciones') {
                    const prop = inventoryDB.propiedades.find(p => p.id === id);
                    if (!prop) return;
                    items = prop.children
                        .map(childId => {
                            if (inventoryDB.habitaciones[childId]) return { ...inventoryDB.habitaciones[childId], id: childId, tipo: 'habitacion' };
                            if (inventoryDB.objetos[childId]) return { ...inventoryDB.objetos[childId], id: childId, tipo: 'objeto' };
                            return null;
                        })
                        .filter(Boolean); // Filtrar nulos
                    title = prop.nombre;
                } else if (level === 'contenidos') {
                    const hab = inventoryDB.habitaciones[id];
                    if (!hab) return;
                    const contenedores = hab.children.filter(childId => childId.startsWith('alm')).map(childId => ({ ...inventoryDB.almacenamientos[childId], id: childId, tipo: 'contenedor' }));
                    const objetosSueltos = hab.children.filter(childId => childId.startsWith('obj')).map(childId => ({ ...inventoryDB.objetos[childId], id: childId, tipo: 'objeto' }));
                    items = [...contenedores, ...objetosSueltos];
                    title = hab.nombre;
                } else if (level === 'objetos') {
                    const alm = inventoryDB.almacenamientos[id];
                    if (!alm) return;
                    items = alm.children.map(childId => ({ ...inventoryDB.objetos[childId], id: childId, tipo: 'objeto' }));
                    title = alm.nombre;
                }

                let backButtonHTML = '';
                if (navStack.length > 0) {
                    backButtonHTML = `<button id="inventory-back-btn" class="p-2 mr-3 -ml-2 text-gray-600 rounded-full hover:bg-gray-200 dark:text-gray-300 dark:hover:bg-gray-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>`;
                }
                inventoryNavHeader.innerHTML = `${backButtonHTML}<h1 class="text-2xl font-bold text-gray-800 truncate dark:text-white">${title}</h1>`;

                if (items.length > 0) {
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = "flex items-center justify-between p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 card dark:bg-gray-700 dark:border-gray-600";
                        div.dataset.id = item.id;
                        let nextLevel = '', icon = item.icono || '📁';
                        if (item.tipo === 'propiedad') { nextLevel = 'habitaciones'; icon = item.icono || '🏠'; }
                        if (item.tipo === 'habitacion') {
                            nextLevel = 'contenidos';
                            // Iconos personalizados para habitaciones específicas
                            if (item.icono) {
                                icon = item.icono;
                            } else {
                                icon = '🚪';
                            }
                        }
                        if (item.tipo === 'contenedor') {
                            nextLevel = 'objetos';
                            icon = item.icono || '📦';
                        }
                        if (item.tipo === 'objeto') {
                            icon = item.icono || '🔩';
                        }
                        if (nextLevel) div.dataset.nextLevel = nextLevel;

                        div.innerHTML = `<div class="flex items-center"><span class="mr-4 text-2xl">${icon}</span><span class="font-medium text-gray-800 dark:text-gray-100">${item.nombre}</span></div>${item.tipo !== 'objeto' ? '<svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' : ''}`;
                        inventoryContent.appendChild(div);
                    });
                } else {
                    inventoryContent.innerHTML = `<p class="py-10 text-center text-gray-500 dark:text-gray-400">No hay elementos aquí.</p>`;
                }

                const addButtonsContainer = document.createElement('div');
                addButtonsContainer.className = "mt-4 space-y-3";

                const buttonConfig = {
                    'propiedades': [{ text: '+ Añadir Propiedad', type: 'propiedad' }],
                    'habitaciones': [
                        { text: '+ Añadir Habitación', type: 'habitacion' },
                        { text: '+ Añadir Objeto', type: 'objeto_principal' } // Añadir objeto a propiedad
                    ],
                    'contenidos': [
                        { text: '+ Añadir Almacenamiento', type: 'almacenamiento' },
                        { text: '+ Añadir Objeto', type: 'objeto_principal' } // Añadir objeto a habitación
                    ],
                    'objetos': [{ text: '+ Añadir Objeto', type: 'objeto_principal' }] // Añadir objeto a almacenamiento
                };

                if (buttonConfig[level]) {
                    buttonConfig[level].forEach(config => {
                        const addButton = document.createElement('button');
                        addButton.className = "w-full py-3 font-semibold text-blue-600 border-2 border-blue-500 border-dashed rounded-lg hover:bg-blue-50 dark:hover:bg-gray-700 dark:text-blue-400 dark:border-blue-400";
                        addButton.textContent = config.text;
                        addButton.addEventListener('click', () => {
                            if (config.type === 'objeto_principal') {
                                modal.dataset.parentId = id;
                                addObjectBtn.dispatchEvent(new Event('click'));
                            } else {
                                modalGenericTitle.textContent = config.text.replace('+', 'Añadir');
                                modalGenericInput.placeholder = `Nombre de ${config.type}`;
                                modalAddGeneric.dataset.addType = config.type;
                                modalAddGeneric.dataset.parentId = id;
                                modalAddGeneric.classList.remove('hidden');
                                modalAddGeneric.classList.add('flex');
                                modalGenericInput.focus();
                            }
                        });
                        addButtonsContainer.appendChild(addButton);
                    });
                    inventoryContent.appendChild(addButtonsContainer);
                }

                inventoryContent.querySelectorAll('div[data-id]').forEach(el => {
                    el.addEventListener('click', () => {
                        if (el.dataset.nextLevel) {
                            navStack.push({ level, id });
                            renderInventory(el.dataset.nextLevel, el.dataset.id);
                        }
                    });
                });

                if (document.getElementById('inventory-back-btn')) {
                    document.getElementById('inventory-back-btn').addEventListener('click', () => {
                        const lastState = navStack.pop();
                        if (lastState) renderInventory(lastState.level, lastState.id);
                    });
                }
            }

            document.querySelector('[data-screen="inventory"]').addEventListener('click', () => {
                navStack = [];
                renderInventory('propiedades');
            });

            // --- LÓGICA DE BÚSQUEDA (NUESTRA VERSIÓN) ---
            function performSearch() {
                const term = searchInput.value.trim().toLowerCase();
                // Permitir búsqueda desde 1 carácter
                if (term.length < 1) {
                    searchResultsContent.innerHTML = '<p class="py-10 text-center text-gray-500 dark:text-gray-400">Escribe para buscar objetos...</p>';
                    return;
                }

                hideAllScreens();
                screenSearchResults.classList.remove('hidden');
                searchResultsContent.innerHTML = '';

                // Coincidencia parcial en cualquier parte del nombre
                const results = Object.keys(inventoryDB.objetos).filter(objId => {
                    const obj = inventoryDB.objetos[objId];
                    return obj.nombre && obj.nombre.toLowerCase().includes(term);
                });

                if (results.length > 0) {
                    results.forEach(objId => {
                        const obj = inventoryDB.objetos[objId];
                        const path = getFullPath('objetos', objId);
                        const div = document.createElement('div');
                        div.className = 'flex items-center p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-blue-50 dark:bg-gray-800 dark:hover:bg-gray-700';
                        div.innerHTML = `
                            <img src="img/${obj.img || 'placeholder.jpg'}" alt="${obj.nombre}" class="w-14 h-14 object-cover rounded-lg mr-3 border border-gray-200 dark:border-gray-700">
                            <div>
                                <div class="font-semibold text-gray-800 dark:text-white">${obj.nombre}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${path}</div>
                            </div>
                        `;
                        // Al hacer click, navegar y resaltar
                        div.addEventListener('click', () => {
                            navigateToObjectInInventory(objId);
                        });
                        searchResultsContent.appendChild(div);
                    });
                } else {
                    searchResultsContent.innerHTML = '<p class="py-10 text-center text-gray-500 dark:text-gray-400">No se encontraron objetos.</p>';
                }
            }
            searchInput.addEventListener('input', performSearch);
            searchBackBtn.addEventListener('click', () => {
                searchInput.value = '';
                showScreen('home');
            });

            // --- RENDER CATEGORÍAS HOME (NUESTRA VERSIÓN) ---
            // --- RENDER AÑADIDOS RECIENTEMENTE ---
            function renderRecentlyAdded() {
                const container = document.getElementById('home-recent-list');
                container.innerHTML = '';
                // Tomar los 4 objetos más recientes (por id de creación, o por orden en la lista)
                const recentObjs = Object.entries(inventoryDB.objetos)
                    .slice(-4)
                    .map(([id, obj]) => ({ id, ...obj }))
                    .reverse();
                recentObjs.forEach(obj => {
                    const div = document.createElement('div');
                    div.className = 'inline-block mr-3 bg-white rounded-lg shadow cursor-pointer hover:bg-blue-50 dark:bg-gray-800 dark:hover:bg-gray-700 p-1';
                    div.style.transition = 'background 0.15s';
                    div.innerHTML = `<img src="img/${obj.img || 'default.jpg'}" alt="${obj.nombre}" class="w-20 h-20 rounded-lg object-cover mb-1" data-obj-id="${obj.id}"><div class="text-xs text-center mt-1 font-semibold text-gray-800 dark:text-white" data-obj-id="${obj.id}">${obj.nombre}</div>`;
                    // Hacer clickeable toda la tarjeta (div), imagen y título
                    div.addEventListener('click', () => {
                        navigateToObjectInInventory(obj.id);
                    });
                    div.querySelectorAll('[data-obj-id]').forEach(el => {
                        el.style.cursor = 'pointer';
                        el.addEventListener('click', (e) => {
                            e.stopPropagation();
                            navigateToObjectInInventory(obj.id);
                        });
                    });
                    container.appendChild(div);
                });
                // Navegar y resaltar objeto en inventario desde cualquier parte
                function navigateToObjectInInventory(objId) {
                    // Buscar la ruta hasta el objeto
                    // 1. Buscar el parent (puede ser almacenamiento, habitación o propiedad)
                    const obj = inventoryDB.objetos[objId];
                    if (!obj) return;
                    let parentId = obj.parent;
                    let parentType = null;
                    // Determinar tipo de parent
                    if (inventoryDB.almacenamientos[parentId]) {
                        parentType = 'almacenamientos';
                    } else if (inventoryDB.habitaciones[parentId]) {
                        parentType = 'habitaciones';
                    } else if (inventoryDB.propiedades.find(p => p.id === parentId)) {
                        parentType = 'propiedades';
                    }
                    // Navegar la pila según el tipo
                    navStack = [];
                    if (parentType === 'almacenamientos') {
                        // Buscar la habitación y propiedad
                        const alm = inventoryDB.almacenamientos[parentId];
                        const habId = alm.parent;
                        const hab = inventoryDB.habitaciones[habId];
                        const propId = hab.parent;
                        navStack.push({ level: 'propiedades', id: null });
                        navStack.push({ level: 'habitaciones', id: propId });
                        navStack.push({ level: 'contenidos', id: habId });
                        renderInventory('objetos', parentId);
                    } else if (parentType === 'habitaciones') {
                        // Buscar la propiedad
                        const hab = inventoryDB.habitaciones[parentId];
                        const propId = hab.parent;
                        navStack.push({ level: 'propiedades', id: null });
                        navStack.push({ level: 'habitaciones', id: propId });
                        renderInventory('contenidos', parentId);
                    } else if (parentType === 'propiedades') {
                        navStack.push({ level: 'propiedades', id: null });
                        renderInventory('habitaciones', parentId);
                    }
                    // Mostrar pantalla de inventario
                    showScreen('inventory');
                    // Resaltar el objeto
                    setTimeout(() => {
                        const el = document.querySelector(`[data-id="${objId}"]`);
                        if (el) {
                            el.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
                            setTimeout(() => {
                                el.classList.remove('ring-2', 'ring-blue-500', 'ring-offset-2');
                            }, 1800);
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 120);
                }
            }
            function renderHomeCategories() {
                const container = document.getElementById('home-categories-list');
                container.innerHTML = '';
                if (inventoryDB.categorias.length === 0) {
                    container.innerHTML = `<p class="py-10 text-center text-gray-500 dark:text-gray-400 col-span-full">No tienes categorías.</p>`;
                    return;
                }
                // Mostrar como grid de 2 columnas, estilo bonito
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-2';
                inventoryDB.categorias.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-center';
                    const pill = document.createElement('span');
                    pill.className = 'category-pill';
                    pill.textContent = cat.nombre;
                    div.appendChild(pill);
                    grid.appendChild(div);
                });
                container.appendChild(grid);
                grid.className = 'grid grid-cols-2 gap-2';
                inventoryDB.categorias.forEach(cat => {
                    const div = document.createElement('div');
                    div.textContent = cat.nombre;
                    div.className = 'px-3 py-2 rounded-full border border-blue-300 bg-white text-gray-800 dark:bg-gray-800 dark:text-gray-200 dark:border-blue-700 shadow-sm font-medium text-sm text-center';
                    grid.appendChild(div);
                });
                container.appendChild(grid);
            }

            // --- NAVEGACIÓN Y CRUD DE PERFIL (NUESTRA VERSIÓN) ---
            // --- CERRAR SESIÓN ---
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function () {
                    showLoginScreen();
                });
            }
            navToPropertiesBtn.addEventListener('click', () => {
                renderPropertiesCRUD();
                showScreen('properties');
            });
            propertiesBackBtn.addEventListener('click', () => showScreen('profile'));
            addPropertyCrudBtn.addEventListener('click', () => {
                modalGenericTitle.textContent = 'Añadir Nueva Propiedad';
                modalGenericInput.placeholder = 'Nombre de la propiedad';
                modalAddGeneric.dataset.addType = 'propiedad';
                modalAddGeneric.classList.remove('hidden');
                modalAddGeneric.classList.add('flex');
                modalGenericInput.focus();
            });

            function renderPropertiesCRUD() {
                propertiesList.innerHTML = '';
                if (inventoryDB.propiedades.length === 0) {
                    propertiesList.innerHTML = `<p class="py-10 text-center text-gray-500">No tienes propiedades.</p>`;
                    return;
                }
                inventoryDB.propiedades.forEach(prop => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-4 bg-white border border-gray-200 rounded-lg card";
                    div.innerHTML = `
                        <div class="flex items-center">
                            <span class="mr-4 text-2xl">${prop.icono || '🏠'}</span>
                            <span class="font-medium text-gray-800 dark:text-gray-100">${prop.nombre}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="icon-button edit" data-id="${prop.id}" data-name="${prop.nombre}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button class="icon-button delete" data-id="${prop.id}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    propertiesList.appendChild(div);
                });

                propertiesList.querySelectorAll('.edit').forEach(btn => {
                    btn.addEventListener('click', () => {
                        modalGenericTitle.textContent = 'Editar Propiedad';
                        modalGenericInput.value = btn.dataset.name;
                        modalAddGeneric.dataset.addType = 'propiedad_edit';
                        modalAddGeneric.dataset.editId = btn.dataset.id;
                        modalAddGeneric.classList.remove('hidden');
                        modalAddGeneric.classList.add('flex');
                        modalGenericInput.focus();
                    });
                });

                propertiesList.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const propId = btn.dataset.id;
                        const index = inventoryDB.propiedades.findIndex(p => p.id === propId);
                        if (index > -1) {
                            inventoryDB.propiedades.splice(index, 1);
                            renderPropertiesCRUD();
                        }
                    });
                });
            }

            navToCategoriesBtn.addEventListener('click', () => {
                renderCategoriesCRUD();
                showScreen('categories');
            });
            categoriesBackBtn.addEventListener('click', () => showScreen('profile'));
            addCategoryCrudBtn.addEventListener('click', openAddCategoryModal);

            function renderCategoriesCRUD() {
                categoriesList.innerHTML = '';
                if (inventoryDB.categorias.length === 0) {
                    categoriesList.innerHTML = `<p class="py-10 text-center text-gray-500">No tienes categorías.</p>`;
                    return;
                }
                inventoryDB.categorias.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-4 bg-white border border-gray-200 rounded-lg card";
                    div.innerHTML = `
                        <span class="font-medium text-gray-800 dark:text-gray-100">${cat.nombre}</span>
                        <div class="flex space-x-2">
                            <button class="icon-button edit" data-id="${cat.id}" data-name="${cat.nombre}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                            </button>
                            <button class="icon-button delete" data-id="${cat.id}">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    categoriesList.appendChild(div);
                });

                categoriesList.querySelectorAll('.edit').forEach(btn => {
                    btn.addEventListener('click', () => {
                        modalGenericTitle.textContent = 'Editar Categoría';
                        modalGenericInput.value = btn.dataset.name;
                        modalAddGeneric.dataset.addType = 'categoria_edit';
                        modalAddGeneric.dataset.editId = btn.dataset.id;
                        modalAddGeneric.classList.remove('hidden');
                        modalAddGeneric.classList.add('flex');
                        modalGenericInput.focus();
                    });
                });

                categoriesList.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const catId = btn.dataset.id;
                        const index = inventoryDB.categorias.findIndex(c => c.id === catId);
                        if (index > -1) {
                            inventoryDB.categorias.splice(index, 1);
                            renderCategoriesCRUD();
                            renderHomeCategories();
                        }
                    });
                });
            }

            // --- NUEVAS FUNCIONES DE ALERTA ---
            function getPriorityClasses(alert) {
                if (!alert.active) {
                    return { // Estilo Desactivado
                        border: 'border-l-4 border-gray-400 dark:border-gray-600',
                        bg: 'bg-gray-100/60 dark:bg-gray-800/50',
                        text: 'text-gray-600 dark:text-gray-400',
                        iconBg: 'bg-gray-200 dark:bg-gray-700',
                        iconText: 'text-gray-500 dark:text-gray-400'
                    };
                }
                switch (alert.priority) {
                    case 'alta':
                        return {
                            border: 'border-l-4 border-red-500 dark:border-red-400',
                            bg: 'bg-red-100/60 dark:bg-red-900/50',
                            text: 'text-red-800 dark:text-red-200',
                            iconBg: 'bg-red-100 dark:bg-red-800',
                            iconText: 'text-red-500 dark:text-red-300'
                        };
                    case 'media':
                        return {
                            border: 'border-l-4 border-yellow-500 dark:border-yellow-400',
                            bg: 'bg-yellow-100/60 dark:bg-yellow-900/50',
                            text: 'text-yellow-800 dark:text-yellow-200',
                            iconBg: 'bg-yellow-100 dark:bg-yellow-800',
                            iconText: 'text-yellow-500 dark:text-yellow-300'
                        };
                    case 'baja':
                    default:
                        return {
                            border: 'border-l-4 border-blue-500 dark:border-blue-400',
                            bg: 'bg-blue-100/60 dark:bg-blue-900/50',
                            text: 'text-blue-800 dark:text-blue-200',
                            iconBg: 'bg-blue-100 dark:bg-blue-800',
                            iconText: 'text-blue-500 dark:text-blue-300'
                        };
                }
            }

            function formatAlertDate(dateString) {
                if (!dateString) return 'Sin fecha';
                const parts = dateString.split('-');
                if (parts.length !== 3) return 'Fecha inválida';
                const date = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                if (isNaN(date)) return 'Fecha inválida';

                const todayDate = new Date();
                todayDate.setUTCHours(0, 0, 0, 0);
                const tomorrowDate = new Date(todayDate);
                tomorrowDate.setUTCDate(tomorrowDate.getUTCDate() + 1);

                if (date.getTime() === todayDate.getTime()) return 'Hoy';
                if (date.getTime() === tomorrowDate.getTime()) return 'Mañana';

                const diffTime = date - todayDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    return `Hace ${Math.abs(diffDays)} día${Math.abs(diffDays) > 1 ? 's' : ''}`;
                } else if (diffDays > 1 && diffDays <= 7) {
                    return `En ${diffDays} días`;
                }

                try {
                    return date.toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        timeZone: 'UTC'
                    });
                } catch (e) {
                    return dateString;
                }
            }

            function getIconForPriority(alert) {
                if (!alert.active) {
                    return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>`;
                }
                switch (alert.priority) {
                    case 'alta':
                        return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    case 'media':
                        return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`;
                    case 'baja':
                    default:
                        return `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                }
            }

            function createAlertCardHTML(alert) {
                const classes = getPriorityClasses(alert);
                let locationPath = '';
                if (alert.locationId) {
                    const type = alert.locationId.substring(0, 3);
                    let dbType;
                    if (type === 'pro') dbType = 'propiedades';
                    else if (type === 'hab') dbType = 'habitaciones';
                    else if (type === 'alm') dbType = 'almacenamientos';
                    if (dbType) locationPath = getFullPath(dbType, alert.locationId);
                }

                const objectName = alert.objectId ? inventoryDB.objetos[alert.objectId]?.nombre : '';
                const showCheckbox = alertSelectionMode && currentAlertTab === 'past';

                return `
                    <div class="flex items-start p-4 space-x-4 rounded-lg shadow-sm cursor-pointer card alert-card ${classes.bg} ${classes.border}" data-alert-id="${alert.id}" data-priority="${alert.active ? alert.priority : 'desactivada'}">
                        <div class="p-2 mt-1 ${classes.iconBg} rounded-full flex-shrink-0">
                            <span class="${classes.iconText}">${getIconForPriority(alert)}</span>
                        </div>
                        <div class="flex-grow min-w-0">
                             <div class="flex justify-between items-center">
                                 <p class="font-semibold truncate ${classes.text}">${alert.title}</p>
                                 <p class="text-sm font-medium flex-shrink-0 ml-2 ${classes.text}">${formatAlertDate(alert.date)}</p>
                             </div>
                             ${alert.description ? `<p class="text-sm text-gray-600 dark:text-gray-300 mt-1 truncate">${alert.description}</p>` : ''}
                             ${objectName ? `<p class="text-sm text-gray-500 dark:text-gray-400 mt-2 truncate"><b>Objeto:</b> ${objectName}</p>` : ''}
                             ${locationPath ? `<p class="text-sm text-gray-500 dark:text-gray-400 truncate"><b>Lugar:</b> ${locationPath}</p>` : ''}
                        </div>
                         ${showCheckbox ? `
                            <div class="flex items-center justify-center h-full pl-2 flex-shrink-0">
                                <div class="w-5 h-5 border-2 border-gray-400 rounded-full flex items-center justify-center checkmark-icon dark:border-gray-500" style="background-color: transparent;">
                                    <svg class="w-3 h-3 text-white fill-current" viewBox="0 0 20 20">
                                        <path d="M0 11l2-2 5 5L17 3l3 3L7 19z"/>
                                    </svg>
                                </div>
                            </div>
                         ` : ''}
                    </div>
                `;
            }

            function renderAlertsScreen() {
                try {
                    today = new Date().toISOString().split('T')[0];

                    const importantes = alertsDB
                        .filter(a => a.active && a.date >= today && a.priority === 'alta')
                        .sort((a, b) => new Date(a.date) - new Date(b.date));

                    const proximas = alertsDB
                        .filter(a => a.active && a.date >= today && a.priority !== 'alta')
                        .sort((a, b) => new Date(a.date) - new Date(b.date));

                    const desactivadas = alertsDB.filter(a => !a.active)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));

                    const pasadas = alertsDB
                        .filter(a => a.active && a.date < today)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));

                    listImportantes.innerHTML = importantes.length ? importantes.map(a => createAlertCardHTML(a)).join('') : '<p class="py-2 text-center text-gray-500 dark:text-gray-400">No hay alertas importantes.</p>';
                    listProximas.innerHTML = proximas.length ? proximas.map(a => createAlertCardHTML(a)).join('') : '<p class="py-2 text-center text-gray-500 dark:text-gray-400">No hay más alertas próximas.</p>';
                    listDesactivadas.innerHTML = desactivadas.length ? desactivadas.map(a => createAlertCardHTML(a)).join('') : '<p class="py-2 text-center text-gray-500 dark:text-gray-400">No hay alertas desactivadas.</p>';
                    listPast.innerHTML = pasadas.length ? pasadas.map(a => createAlertCardHTML(a)).join('') : '<p class="py-10 text-center text-gray-500 dark:text-gray-400">No hay alertas pasadas.</p>';

                    addAlertCardClickListeners();
                } catch (error) {
                    console.error("Error rendering alerts:", error);
                    listActuales.innerHTML = "<p class='text-red-500 p-4'>Error al cargar las alertas.</p>";
                    listPast.innerHTML = "<p class='text-red-500 p-4'>Error al cargar las alertas.</p>";
                }
            }

            function addAlertCardClickListeners() {
                document.querySelectorAll('#screen-alerts .alert-card').forEach(card => {
                    card.onclick = null; // Prevenir duplicados
                    card.addEventListener('click', () => {
                        const alertId = card.dataset.alertId;
                        const alert = alertsDB.find(a => a.id === alertId);
                        if (!alert) return;

                        if (alertSelectionMode && currentAlertTab === 'past') {
                            card.classList.toggle('selected');
                            const checkmark = card.querySelector('.checkmark-icon');
                            if (!checkmark) return;
                            if (card.classList.contains('selected')) {
                                checkmark.style.backgroundColor = '#3b82f6';
                                checkmark.style.borderColor = '#3b82f6';
                            } else {
                                checkmark.style.backgroundColor = 'transparent';
                                checkmark.style.borderColor = appFrame.classList.contains('dark') ? '#6b7280' : '#9ca3af';
                            }
                        } else {
                            openViewAlertModal(alert);
                        }
                    });
                });
            }

            function openAlertModal(alert = null) {
                if (alert) {
                    alertModalTitle.textContent = 'Modificar Alerta';
                    saveAlertBtn.textContent = 'Guardar Cambios';
                    modalAddAlert.dataset.editingId = alert.id;

                    alertTitleInput.value = alert.title;
                    alertDescriptionInput.value = alert.description;
                    alertDateInput.value = alert.date;
                    alertPriorityInput.value = alert.priority;
                    alertLocationInput.value = alert.locationId;
                    alertObjectInput.value = alert.objectId;
                    alertRepetitiveCheckbox.checked = alert.repetitive;
                    alertRepeatFrequencyInput.value = alert.repeatFrequency;
                } else {
                    alertModalTitle.textContent = 'Añadir Nueva Alerta';
                    saveAlertBtn.textContent = 'Guardar Alerta';
                    modalAddAlert.dataset.editingId = '';

                    alertTitleInput.value = '';
                    alertDescriptionInput.value = '';
                    alertDateInput.value = '';
                    alertPriorityInput.value = 'baja';
                    alertLocationInput.value = '';
                    alertObjectInput.value = '';
                    alertRepetitiveCheckbox.checked = false;
                }

                alertRepetitiveCheckbox.dispatchEvent(new Event('change'));
                modalAddAlert.classList.remove('hidden');
                modalAddAlert.classList.add('flex');
            }

            function closeAlertModal() {
                modalAddAlert.classList.add('hidden');
                modalAddAlert.classList.remove('flex');
            }

            function openViewAlertModal(alert) {
                modalViewAlert.dataset.alertId = alert.id;
                viewAlertTitle.textContent = alert.title;
                viewAlertDate.textContent = formatAlertDate(alert.date) + (alert.repetitive ? ` (Repite ${alert.repeatFrequency})` : '');
                viewAlertDescription.textContent = alert.description || 'Sin descripción.';

                let locationPath = '';
                if (alert.locationId) {
                    const type = alert.locationId.substring(0, 3);
                    let dbType;
                    if (type === 'pro') dbType = 'propiedades';
                    else if (type === 'hab') dbType = 'habitaciones';
                    else if (type === 'alm') dbType = 'almacenamientos';
                    if (dbType) locationPath = getFullPath(dbType, alert.locationId);
                }
                const objectName = alert.objectId ? inventoryDB.objetos[alert.objectId]?.nombre : '';
                let locationHTML = '';
                if (objectName) locationHTML += `<p><b>Objeto:</b> ${objectName}</p>`;
                if (locationPath) locationHTML += `<p><b>Lugar:</b> ${locationPath}</p>`;
                viewAlertLocation.innerHTML = locationHTML || '<p class="text-gray-500 dark:text-gray-400">Sin ubicación/objeto asociado.</p>';

                if (!alert.active) {
                    alertModalModify.classList.add('hidden');
                    alertModalDeactivate.classList.add('hidden');
                    alertModalReactivate.classList.remove('hidden');
                    alertModalDelete.classList.remove('hidden');
                } else if (alert.active && alert.date < today) { // Pasada
                    alertModalModify.classList.remove('hidden');
                    alertModalDeactivate.classList.remove('hidden');
                    alertModalReactivate.classList.add('hidden');
                    alertModalDelete.classList.remove('hidden');
                } else { // Actual
                    alertModalModify.classList.remove('hidden');
                    alertModalDeactivate.classList.remove('hidden');
                    alertModalReactivate.classList.add('hidden');
                    alertModalDelete.classList.remove('hidden');
                }

                modalViewAlert.classList.remove('hidden');
                modalViewAlert.classList.add('flex');
            }

            function closeViewAlertModal() {
                modalViewAlert.classList.add('hidden');
                modalViewAlert.classList.remove('flex');
            }

            function toggleAlertSelectionMode(forceState) {
                const newState = forceState ?? !alertSelectionMode;
                if (currentAlertTab !== 'past' && newState) return;

                alertSelectionMode = newState;

                if (alertSelectionMode) {
                    alertEditBtn.textContent = 'Cancelar';
                    alertSelectionFooter.classList.remove('hidden');
                    openAlertModalBtn.classList.add('hidden');
                } else {
                    alertEditBtn.textContent = 'Eliminar';
                    alertSelectionFooter.classList.add('hidden');
                    openAlertModalBtn.classList.remove('hidden');
                    // Deseleccionar todo
                    document.querySelectorAll('#alert-list-past .alert-card.selected').forEach(card => {
                        card.classList.remove('selected');
                        const checkmark = card.querySelector('.checkmark-icon');
                        if (checkmark) {
                            checkmark.style.backgroundColor = 'transparent';
                            checkmark.style.borderColor = appFrame.classList.contains('dark') ? '#6b7280' : '#9ca3af';
                        }
                    });
                }

                // Re-renderizar solo la pestaña 'past' para mostrar/ocultar checkboxes
                if (currentAlertTab === 'past') {
                    const pasadas = alertsDB
                        .filter(a => a.active && a.date < today)
                        .sort((a, b) => new Date(b.date) - new Date(a.date));
                    listPast.innerHTML = pasadas.length ? pasadas.map(a => createAlertCardHTML(a)).join('') : '<p class="py-10 text-center text-gray-500 dark:text-gray-400">No hay alertas pasadas.</p>';
                    addAlertCardClickListeners();
                }
            }

            function populateAlertModalSelects() {
                // Llenar Ubicaciones
                alertLocationInput.innerHTML = '<option value="">Ninguna</option>';
                inventoryDB.propiedades.forEach(prop => {
                    let optionsHTML = `<option value="${prop.id}">${prop.nombre} (Completo)</option>`;
                    prop.children.forEach(childId => {
                        if (inventoryDB.habitaciones[childId]) {
                            const hab = inventoryDB.habitaciones[childId];
                            optionsHTML += `<option value="${childId}">&nbsp;&nbsp;${hab.nombre}</option>`;
                            hab.children.forEach(grandChildId => {
                                if (grandChildId.startsWith('alm')) {
                                    const alm = inventoryDB.almacenamientos[grandChildId];
                                    optionsHTML += `<option value="${grandChildId}">&nbsp;&nbsp;&nbsp;&nbsp;${alm.nombre}</option>`;
                                }
                            });
                        }
                    });
                    alertLocationInput.innerHTML += `<optgroup label="${prop.nombre}">${optionsHTML}</optgroup>`;
                });

                // Llenar Objetos
                alertObjectInput.innerHTML = '<option value="">Ninguno</option>';
                let objectsHTML = '';
                inventoryDB.propiedades.forEach(prop => {
                    let currentGroupLabel = prop.nombre;
                    let propLevelObjectsHTML = '';

                    const findObjectsRecursive = (parentId, indentLevel) => {
                        let itemsHtml = '';
                        Object.keys(inventoryDB.objetos).forEach(objId => {
                            if (inventoryDB.objetos[objId].parent === parentId) {
                                itemsHtml += `<option value="${objId}">${"&nbsp;".repeat(indentLevel * 2)}${inventoryDB.objetos[objId].nombre}</option>`;
                            }
                        });

                        let childrenIds = [];
                        if (inventoryDB.propiedades.find(p => p.id === parentId)) childrenIds = inventoryDB.propiedades.find(p => p.id === parentId).children;
                        else if (inventoryDB.habitaciones[parentId]) childrenIds = inventoryDB.habitaciones[parentId].children;
                        else if (inventoryDB.almacenamientos[parentId]) childrenIds = inventoryDB.almacenamientos[parentId].children;

                        childrenIds.forEach(childId => {
                            let childName = '';
                            let isContainer = false;
                            if (inventoryDB.habitaciones[childId]) {
                                childName = inventoryDB.habitaciones[childId].nombre;
                                isContainer = true;
                            } else if (inventoryDB.almacenamientos[childId]) {
                                childName = inventoryDB.almacenamientos[childId].nombre;
                                isContainer = true;
                            }

                            if (isContainer) {
                                const subItemsHtml = findObjectsRecursive(childId, indentLevel + 1);
                                if (subItemsHtml) {
                                    itemsHtml += `<optgroup label="${"&nbsp;".repeat(indentLevel * 2)}${childName}">${subItemsHtml}</optgroup>`;
                                }
                            }
                        });
                        return itemsHtml;
                    };

                    propLevelObjectsHTML = findObjectsRecursive(prop.id, 0);

                    if (propLevelObjectsHTML) {
                        objectsHTML += `<optgroup label="${prop.nombre}">${propLevelObjectsHTML}</optgroup>`;
                    }
                });
                alertObjectInput.innerHTML += objectsHTML;
            }

            // --- NUEVOS LISTENERS DE ALERTA ---
            openAlertModalBtn.addEventListener('click', () => openAlertModal(null));
            closeAlertModalBtn.addEventListener('click', closeAlertModal);

            saveAlertBtn.addEventListener('click', () => {
                const id = modalAddAlert.dataset.editingId;
                if (!alertTitleInput.value.trim() || !alertDateInput.value) {
                    // Reemplazar alert() con una indicación visual
                    alertTitleInput.classList.add('border-red-500');
                    alertDateInput.classList.add('border-red-500');
                    setTimeout(() => {
                        alertTitleInput.classList.remove('border-red-500');
                        alertDateInput.classList.remove('border-red-500');
                    }, 2000);
                    return;
                }

                const newAlert = {
                    id: id || `alert${Date.now()}`,
                    title: alertTitleInput.value.trim(),
                    description: alertDescriptionInput.value.trim(),
                    date: alertDateInput.value,
                    priority: alertPriorityInput.value,
                    locationId: alertLocationInput.value,
                    objectId: alertObjectInput.value,
                    repetitive: alertRepetitiveCheckbox.checked,
                    repeatFrequency: alertRepetitiveCheckbox.checked ? alertRepeatFrequencyInput.value : null,
                    active: true
                };

                if (id) {
                    const index = alertsDB.findIndex(a => a.id === id);
                    if (index !== -1) alertsDB[index] = newAlert;
                    else alertsDB.push(newAlert);
                } else {
                    alertsDB.push(newAlert);
                }
                closeAlertModal();
                renderAlertsScreen();
            });

            alertRepetitiveCheckbox.addEventListener('change', () => {
                alertRepeatOptions.classList.toggle('hidden', !alertRepetitiveCheckbox.checked);
            });

            alertModalCancel.addEventListener('click', closeViewAlertModal);

            alertModalDelete.addEventListener('click', () => {
                const id = modalViewAlert.dataset.alertId;
                alertsDB = alertsDB.filter(a => a.id !== id);
                closeViewAlertModal();
                renderAlertsScreen();
            });

            alertModalDeactivate.addEventListener('click', () => {
                const id = modalViewAlert.dataset.alertId;
                const index = alertsDB.findIndex(a => a.id === id);
                if (index !== -1) alertsDB[index].active = false;
                closeViewAlertModal();
                renderAlertsScreen();
            });

            alertModalReactivate.addEventListener('click', () => {
                const id = modalViewAlert.dataset.alertId;
                const index = alertsDB.findIndex(a => a.id === id);
                if (index !== -1) {
                    alertsDB[index].active = true;
                    // Opcional: si la fecha es pasada, actualizarla a hoy
                    if (alertsDB[index].date < today) {
                        alertsDB[index].date = today;
                    }
                }
                closeViewAlertModal();
                renderAlertsScreen();
            });

            alertModalModify.addEventListener('click', () => {
                const id = modalViewAlert.dataset.alertId;
                const alert = alertsDB.find(a => a.id === id);
                if (alert) {
                    closeViewAlertModal();
                    openAlertModal(alert);
                }
            });

            alertTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    currentAlertTab = tabName;

                    alertTabs.forEach(t => {
                        t.classList.remove('text-blue-600', 'border-blue-600');
                        t.classList.add('text-gray-500', 'dark:text-gray-400');
                    });
                    tab.classList.add('text-blue-600', 'border-blue-600');
                    tab.classList.remove('text-gray-500', 'dark:text-gray-400');

                    alertLists.forEach(list => list.classList.add('hidden'));
                    document.getElementById(`alert-list-${tabName}`).classList.remove('hidden');

                    if (tabName === 'past') {
                        alertEditBtn.classList.remove('hidden');
                        alertSelectionFooter.classList.toggle('hidden', !alertSelectionMode);
                    } else {
                        alertEditBtn.classList.add('hidden');
                        alertSelectionFooter.classList.add('hidden');
                        if (alertSelectionMode) toggleAlertSelectionMode(false); // Salir del modo edición
                    }
                });
            });

            alertEditBtn.addEventListener('click', () => toggleAlertSelectionMode());

            alertDeleteSelectedBtn.addEventListener('click', () => {
                const selectedIds = [];
                document.querySelectorAll('#alert-list-past .alert-card.selected').forEach(card => {
                    selectedIds.push(card.dataset.alertId);
                });

                if (selectedIds.length > 0) {
                    alertsDB = alertsDB.filter(a => !selectedIds.includes(a.id));
                    toggleAlertSelectionMode(false); // Sale del modo edición y re-renderiza
                } else {
                    // No usar alert()
                    console.warn("No hay alertas seleccionadas para eliminar.");
                }
            });

            // --- INICIALIZACIÓN ---
            renderHomeCategories();
            renderRecentlyAdded();
            populateAlertModalSelects(); // <-- NUEVO
            // Mostrar login si no está logueado
            if (!isLoggedIn) {
                showLoginScreen();
            } else {
                showScreen('home');
                document.querySelector('.nav-button[data-screen="home"]').classList.add(activeTextColorClass, activeNavButtonClass);
                document.querySelector('.nav-button[data-screen="home"]').classList.remove(inactiveTextColorClass, darkInactiveTextColorClass);
            }

        });
    </script>
</body>

</html>